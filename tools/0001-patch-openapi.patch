From 9c6c55261ebd2a4f265c51c8528c56327976adc2 Mon Sep 17 00:00:00 2001
From: Nils Ponsard | Nitrokey <nils@nitrokey.com>
Date: Tue, 1 Aug 2023 11:31:19 +0200
Subject: [PATCH] Revert "a"

This reverts commit 7665a319cdc3bd27394062fb3e28797bb59ae1e4.
---
 openapi/Cargo.toml                |  2 +-
 openapi/src/apis/configuration.rs |  4 +-
 openapi/src/apis/default_api.rs   | 69 ++++++++++++++++++++++++++-----
 openapi/src/models/public_key.rs  |  4 +-
 5 files changed, 64 insertions(+), 17 deletions(-)

diff --git a/openapi/Cargo.toml b/openapi/Cargo.toml
index 47a9643..f82e16d 100644
--- a/openapi/Cargo.toml
+++ b/openapi/Cargo.toml
@@ -13,4 +13,4 @@ serde_derive = "^1.0"
 serde_json = "^1.0"
 url = "^2.2"
 uuid = { version = "^1.0", features = ["serde"] }
-reqwest = "~0.9"
+reqwest = {version = "^0.11", features = ["blocking", "json"]}
diff --git a/openapi/src/apis/configuration.rs b/openapi/src/apis/configuration.rs
index 078ba5c..f51354c 100644
--- a/openapi/src/apis/configuration.rs
+++ b/openapi/src/apis/configuration.rs
@@ -12,7 +12,7 @@
 pub struct Configuration {
     pub base_path: String,
     pub user_agent: Option<String>,
-    pub client: reqwest::Client,
+    pub client: reqwest::blocking::Client,
     pub basic_auth: Option<BasicAuth>,
     pub oauth_access_token: Option<String>,
     pub bearer_access_token: Option<String>,
@@ -39,7 +39,7 @@ impl Default for Configuration {
         Configuration {
             base_path: "https://nethsmdemo.nitrokey.com/api/v1".to_owned(),
             user_agent: Some("OpenAPI-Generator/v1/rust".to_owned()),
-            client: reqwest::Client::new(),
+            client: reqwest::blocking::Client::new(),
             basic_auth: None,
             oauth_access_token: None,
             bearer_access_token: None,
diff --git a/openapi/src/apis/default_api.rs b/openapi/src/apis/default_api.rs
index b585dc7..946226f 100644
--- a/openapi/src/apis/default_api.rs
+++ b/openapi/src/apis/default_api.rs
@@ -8,10 +8,10 @@
  * Generated by: https://openapi-generator.tech
  */
 
-use reqwest;
+use reqwest::{self, header::HeaderValue};
 
 use super::{configuration, Error};
-use crate::apis::ResponseContent;
+use crate::{apis::ResponseContent, models::PrivateKey};
 
 /// struct for typed errors of method [`config_backup_passphrase_put`]
 #[derive(Debug, Clone, Serialize, Deserialize)]
@@ -1449,7 +1449,7 @@ pub fn info_get(
 pub fn keys_generate_post(
     configuration: &configuration::Configuration,
     key_generate_request_data: crate::models::KeyGenerateRequestData,
-) -> Result<(), Error<KeysGeneratePostError>> {
+) -> Result<String, Error<KeysGeneratePostError>> {
     let local_var_configuration = configuration;
 
     let local_var_client = &local_var_configuration.client;
@@ -1473,11 +1473,30 @@ pub fn keys_generate_post(
     let local_var_req = local_var_req_builder.build()?;
     let mut local_var_resp = local_var_client.execute(local_var_req)?;
 
+    let response_headers = local_var_resp.headers().clone();
+
     let local_var_status = local_var_resp.status();
     let local_var_content = local_var_resp.text()?;
 
+    let default = HeaderValue::from_static("unknown");
+
+    let location = response_headers.get("location").unwrap_or(&default);
+
+    // get the id from the logation header value :
+    // location: /api/v1/keys/<id>?mechanisms=ECDSA_Signature
+
+    let key_id = location
+        .to_str()
+        .unwrap_or("")
+        .split('/')
+        .last()
+        .unwrap_or("")
+        .split('?')
+        .next()
+        .unwrap_or("");
+
     if !local_var_status.is_client_error() && !local_var_status.is_server_error() {
-        Ok(())
+        Ok(key_id.to_string())
     } else {
         let local_var_entity: Option<KeysGeneratePostError> =
             serde_json::from_str(&local_var_content).ok();
@@ -1576,7 +1595,7 @@ pub fn keys_key_id_cert_delete(
     } else {
         let local_var_entity: Option<KeysKeyIdCertDeleteError> =
             serde_json::from_str(&local_var_content).ok();
-        let local_var_error = ResponseContent {
+        let local_var_error: ResponseContent<KeysKeyIdCertDeleteError> = ResponseContent {
             status: local_var_status,
             content: local_var_content,
             entity: local_var_entity,
@@ -1613,6 +1632,11 @@ pub fn keys_key_id_cert_get(
         );
     };
 
+    local_var_req_builder = local_var_req_builder.header(
+        reqwest::header::ACCEPT,
+        reqwest::header::HeaderValue::from_static("application/x-pem-file"),
+    );
+
     let local_var_req = local_var_req_builder.build()?;
     let mut local_var_resp = local_var_client.execute(local_var_req)?;
 
@@ -1620,7 +1644,7 @@ pub fn keys_key_id_cert_get(
     let local_var_content = local_var_resp.text()?;
 
     if !local_var_status.is_client_error() && !local_var_status.is_server_error() {
-        serde_json::from_str(&local_var_content).map_err(Error::from)
+        Ok(local_var_content)
     } else {
         let local_var_entity: Option<KeysKeyIdCertGetError> =
             serde_json::from_str(&local_var_content).ok();
@@ -1661,7 +1685,12 @@ pub fn keys_key_id_cert_put(
             local_var_auth_conf.1.to_owned(),
         );
     };
-    local_var_req_builder = local_var_req_builder.json(&body);
+    local_var_req_builder = local_var_req_builder.body(body.to_owned());
+
+    local_var_req_builder = local_var_req_builder.header(
+        reqwest::header::CONTENT_TYPE,
+        reqwest::header::HeaderValue::from_static("application/x-pem-file"),
+    );
 
     let local_var_req = local_var_req_builder.build()?;
     let mut local_var_resp = local_var_client.execute(local_var_req)?;
@@ -1981,7 +2010,7 @@ pub fn keys_key_id_public_pem_get(
 pub fn keys_key_id_put(
     configuration: &configuration::Configuration,
     key_id: &str,
-    body: &str,
+    body: PrivateKey,
     mechanisms: Option<Vec<crate::models::KeyMechanism>>,
     tags: Option<Vec<String>>,
 ) -> Result<(), Error<KeysKeyIdPutError>> {
@@ -2220,10 +2249,10 @@ pub fn keys_key_id_sign_post(
 /// Import a private key into NetHSM and let NetHSM generate a KeyID. The public key will be automatically derived.
 pub fn keys_post(
     configuration: &configuration::Configuration,
-    body: &str,
+    body: PrivateKey,
     mechanisms: Option<Vec<crate::models::KeyMechanism>>,
     tags: Option<Vec<String>>,
-) -> Result<(), Error<KeysPostError>> {
+) -> Result<String, Error<KeysPostError>> {
     let local_var_configuration = configuration;
 
     let local_var_client = &local_var_configuration.client;
@@ -2285,11 +2314,29 @@ pub fn keys_post(
     let local_var_req = local_var_req_builder.build()?;
     let mut local_var_resp = local_var_client.execute(local_var_req)?;
 
+    let response_headers = local_var_resp.headers().clone();
     let local_var_status = local_var_resp.status();
     let local_var_content = local_var_resp.text()?;
 
+    let default = HeaderValue::from_static("unknown");
+
+    let location = response_headers.get("location").unwrap_or(&default);
+
+    // get the id from the logation header value :
+    // location: /api/v1/keys/<id>?mechanisms=ECDSA_Signature
+
+    let key_id = location
+        .to_str()
+        .unwrap_or("")
+        .split('/')
+        .last()
+        .unwrap_or("")
+        .split('?')
+        .next()
+        .unwrap_or("");
+
     if !local_var_status.is_client_error() && !local_var_status.is_server_error() {
-        Ok(())
+        Ok(key_id.to_string())
     } else {
         let local_var_entity: Option<KeysPostError> = serde_json::from_str(&local_var_content).ok();
         let local_var_error = ResponseContent {
diff --git a/openapi/src/models/public_key.rs b/openapi/src/models/public_key.rs
index c406ca5..a13b3b2 100644
--- a/openapi/src/models/public_key.rs
+++ b/openapi/src/models/public_key.rs
@@ -17,7 +17,7 @@ pub struct PublicKey {
     #[serde(rename = "restrictions")]
     pub restrictions: Box<crate::models::KeyRestrictions>,
     #[serde(rename = "key")]
-    pub key: Box<crate::models::KeyPublicData>,
+    pub key: Option<Box<crate::models::KeyPublicData>>,
     #[serde(rename = "operations")]
     pub operations: i32,
 }
@@ -34,7 +34,7 @@ impl PublicKey {
             mechanisms,
             r#type,
             restrictions: Box::new(restrictions),
-            key: Box::new(key),
+            key: Some(Box::new(key)),
             operations,
         }
     }
-- 
2.41.0

